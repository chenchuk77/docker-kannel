#!/bin/bash

{% for channel in channels %}
#
## autogenerated dockers starter script for channel: {{ channel.msisdn }}
#
echo "starting kannel-{{ channel.msisdn }}"
docker run -d --name kannel-{{ channel.msisdn }} \
	   -p {{ channel.http_port }}:13013 \
	   -p {{ channel.smpp.port }}:2776 \
	   --device={{ channel.device }} --cap-add SYS_PTRACE \
           --volume $(readlink -f volumes)/{{ channel.msisdn }}/kannel/etc/:/etc/kannel \
           --volume $(readlink -f volumes)/{{ channel.msisdn }}/kannel/log:/var/log/kannel \
           --volume $(readlink -f volumes)/{{ channel.msisdn }}/kannel/spool:/var/spool/kannel \
           kannelplus:2.1
echo "kannel-{{ channel.msisdn }} started."; sleep 2s

echo "starting tailer-{{ channel.msisdn }}"
docker run -d --name tailer-{{ channel.msisdn }} \
           -p {{ channel.tailer_port }}:8000 \
           --volume $(readlink -f volumes/{{ channel.msisdn }})//tailer/app:/usr/src/app \
           --volume $(readlink -f volumes/{{ channel.msisdn }})/kannel/log:/usr/src/app/log \
           -w /usr/src/app \
           tailer:2.0 node server.js
echo "tailer-{{ channel.msisdn }} started."; sleep 2s
{% endfor %}

{% raw %}
echo ""
docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
{% endraw %}
echo ""

echo "---------------------------------------------"
echo "you can open tailer for logs at: "
echo ""
{% for channel in channels %}
echo "- http://192.168.2.113:{{ channel.tailer_port }}"
{% endfor %}
echo "---------------------------------------------"
echo "to send sms from shell:"
{% for channel in channels %}
echo '- ./volumes/{{ channel.msisdn }}/send.sh 0544434545 "hello from kannel-{{ channel.msisdn }}"'
{% endfor %}
echo "---------------------------------------------"
echo "to send sms via smsbox web interface:"
{% for channel in channels %}
echo "- http://192.168.2.113:{{ channel.http_port }}/cgi-bin/sendsms?username=user&password=pass&from={{ channel.msisdn }}&to=0521112222&text=some%20text%20here"
{% endfor %}
echo "---------------------------------------------"
echo ""
echo ""

